{% extends 'layout.html' %}
{% block content %}
  <section class="filters">
    <form method="get" action="/">
      <label>State
        <select name="state">
          <option {{ 'selected' if state=='All States' }}>All States</option>
          <option>California</option>
          <option>New York</option>
          <option>Texas</option>
        </select>
      </label>
      <label>Year
        <select name="year">
          <option {{ 'selected' if year=='2024' }}>2024</option>
          <option>2023</option>
        </select>
      </label>
      <button type="submit">Apply</button>
    </form>
  </section>

  <section class="cards">
    <div class="card"><div class="k">Total Reviews</div><div class="v">{{ metrics.total_reviews }}</div></div>
    <div class="card ok"><div class="k">Positive Reviews</div><div class="v">{{ metrics.pos_pct }}%</div></div>
    <div class="card warn"><div class="k">Negative Reviews</div><div class="v">{{ metrics.neg_pct }}%</div></div>
    <div class="card"><div class="k">Average Rating</div><div class="v">{{ metrics.avg_rating }}</div></div>
  </section>

  <section class="panel">
    <h3>Sentiment Trend Analysis ({{ year }})</h3>
    <!-- Tiny SVG chart built with Jinja to avoid extra libs -->
    {% set W=720 %}{% set H=220 %}
    {% set pad=30 %}
    {% set months = trend|map(attribute='month')|list %}
    {% set maxY = 100 %}
    <svg viewBox="0 0 {{ W }} {{ H }}" role="img" aria-label="Monthly sentiment trend">
      <rect x="0" y="0" width="{{ W }}" height="{{ H }}" fill="#fff" stroke="#e5e7eb" />
      {% macro path_for(field) -%}
        {%- set n = trend|length -%}
        {%- if n==0 -%}M0 0{%- else -%}
          {%- for p in trend -%}
            {%- set x = pad + (W-2*pad) * loop.index0 / (n-1 if n>1 else 1) -%}
            {%- set y = pad + (H-2*pad) * (1 - (p[field]/maxY)) -%}
            {{ 'M' if loop.first else 'L' }}{{ x }} {{ y }}
          {%- endfor -%}
        {%- endif -%}
      {%- endmacro %}

      <path d="{{ path_for('pos') }}" fill="none" stroke="#22c55e" stroke-width="2" />
      <path d="{{ path_for('neu') }}" fill="none" stroke="#f59e0b" stroke-width="2" />
      <path d="{{ path_for('neg') }}" fill="none" stroke="#ef4444" stroke-width="2" />

      <!-- x labels -->
      {% for p in trend %}
        {% set x = pad + (W-2*pad) * loop.index0 / ((trend|length-1) if (trend|length>1) else 1) %}
        <text x="{{ x }}" y="{{ H-8 }}" text-anchor="middle" class="xlab">{{ p.month[-2:] }}</text>
      {% endfor %}
    </svg>
  </section>
{% endblock %}


